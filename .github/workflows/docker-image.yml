name: Build and Push Docker Images

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]



jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:

    - name: Checkout
      uses: actions/checkout@v2

    - name: Build Images
      working-directory: ./Source
      run: |
        # Yellow Output
        echo -e "\033[0;33m---------------------------------------------------\033[0m"
        echo -e "\033[0;33mUsing docker compose to build & tag images.\033[0m"
        echo -e "\033[0;33mImages will be named as $acrLoginServer/imageName:$dockerTag\033[0m"
        echo -e "\033[0;33m---------------------------------------------------\033[0m"

        docker-compose --file docker-compose.yml build
        #docker build . -t contoso.azurecr.io/k8sdemo:${{ github.sha }}
        #docker push contoso.azurecr.io/k8sdemo:${{ github.sha }}
        #docker-compose -f docker-compose.yml push
      env:
          TAG: ${{ github.sha }}
          REGISTRY: lpm10meus2acr

    - name: Push Images
      uses: azure/docker-login@v1
      with:
        login-server: lpm10meus2acr.azurecr.io
        username: ${{ secrets.REGISTRY_USERNAME }}
        password: ${{ secrets.REGISTRY_PASSWORD }}
      run: |
        docker-compose -f docker-compose.yml push



